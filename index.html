<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>被験者募集掲示板</title>
<script src="https://unpkg.com/lucide"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* アコーディオンアニメーション用スタイル */
    .post-detail {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
    .post-detail.open {
        /* JSで数値をセットするため、ここにはtransitionのみ */
    }
    
    /* 矢印の回転アニメーション */
    .chevron-icon {
        transition: transform 0.3s ease;
    }
    .rotate-180 {
        transform: rotate(180deg);
    }
</style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

<nav id="desktop-nav" class="hidden md:flex justify-center space-x-6 p-4 bg-white shadow-sm sticky top-0 z-50"></nav>

<div class="md:hidden p-4 flex justify-between items-center bg-white shadow-sm sticky top-0 z-50">
    <h1 class="font-bold text-lg">被験者募集掲示板</h1>
    <button id="mobile-menu-btn" class="p-2 rounded hover:bg-gray-100">
        <i data-lucide="menu"></i>
    </button>
</div>
<div id="mobile-nav" class="hidden fixed top-16 left-0 w-full bg-white shadow-md z-40 border-t"></div>

<main id="main-content" class="max-w-4xl mx-auto p-4 min-h-screen"></main>

<footer class="p-8 text-center text-sm text-gray-500 border-t mt-8 bg-white">
    &copy; <span id="year"></span> 被験者募集掲示板
</footer>

<script>
// --- 設定 ---
// 必ずご自身のスプレッドシートのCSV URLに差し替えてください
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRwty1oe-6s7l6GPnMyo-nhQk2vDfnWKsdlzmgdGo1ey7g1QNLusXc_iIbAJYdE8RhLwRnLobvrBvDV/pub?gid=821609257&single=true&output=csv';

// --- ステート管理 ---
let allPosts = [];
let sortOrder = 'newest'; // 'newest' | 'oldest'

// --- DOM要素 ---
const mainContent = document.getElementById('main-content');
const desktopNav = document.getElementById('desktop-nav');
const mobileNavLinks = document.getElementById('mobile-nav');
const mobileMenuBtn = document.getElementById('mobile-menu-btn');

// --- ルーティング設定 ---
const routes = {
    '': { label: 'ホーム', icon: 'home', render: renderHome },
    '#policy': { label: 'ポリシー', icon: 'shield', render: renderPolicy },
    '#recruit': { label: '掲載依頼', icon: 'send', render: renderRecruit },
    '#contact': { label: 'お問い合わせ', icon: 'mail', render: renderContact },
};

// --- 初期化処理 ---
function init() {
    setupNavigation();
    document.getElementById('year').textContent = new Date().getFullYear();
    
    // ハッシュ変更検知
    window.addEventListener('hashchange', handleRoute);
    
    // データ取得開始
    fetchData();
}

// --- ナビゲーション生成 ---
function setupNavigation() {
    const navItems = Object.entries(routes).map(([hash, route]) => ({ hash, label: route.label, icon: route.icon }));

    // PC用メニュー
    desktopNav.innerHTML = navItems.map(item => `
        <a href="${item.hash || '#'}" class="nav-link flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-gray-600 hover:text-blue-600 hover:bg-blue-50 transition-all duration-200" data-hash="${item.hash}">
            <i data-lucide="${item.icon}" class="w-4 h-4"></i>${item.label}
        </a>
    `).join('');

    // スマホ用メニュー
    mobileNavLinks.innerHTML = navItems.map(item => `
        <a href="${item.hash || '#'}" class="nav-link flex items-center gap-3 px-6 py-4 border-b border-gray-100 text-base font-medium text-gray-700 active:bg-gray-50" data-hash="${item.hash}">
            <i data-lucide="${item.icon}" class="w-5 h-5"></i>${item.label}
        </a>
    `).join('');

    // スマホメニュー開閉
    mobileMenuBtn.addEventListener('click', () => {
        mobileNavLinks.classList.toggle('hidden');
        const icon = mobileMenuBtn.querySelector('svg');
        // アイコンは再生成されるため簡易的なトグル処理のみ
    });
    
    // アイコン初期化
    lucide.createIcons();
}

function updateActiveNav(hash) {
    const normalizedHash = hash || '';
    document.querySelectorAll('.nav-link').forEach(link => {
        const isActive = link.dataset.hash === normalizedHash;
        link.classList.toggle('text-blue-600', isActive);
        link.classList.toggle('bg-blue-50', isActive);
    });
    // ページ遷移したらスマホメニューは閉じる
    mobileNavLinks.classList.add('hidden');
}

function handleRoute() {
    const hash = window.location.hash;
    const route = routes[hash] || routes['']; // デフォルトはホーム
    
    updateActiveNav(hash);
    mainContent.innerHTML = route.render();
    lucide.createIcons(); // 新しいHTMLに対してアイコンを描画
    window.scrollTo(0, 0);

    // ホーム画面の場合のみ、追加のイベントリスナーを設定
    if (!hash || hash === '#') {
        attachHomeEvents();
    }
}

// --- データ取得 ---
async function fetchData() {
    try {
        // ローディング表示
        mainContent.innerHTML = `
            <div class="flex justify-center items-center py-20">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"></div>
            </div>`;
            
        const response = await fetch(SHEET_URL);
        if (!response.ok) throw new Error('Network response was not ok');
        const text = await response.text();
        
        allPosts = transformPosts(parseCSV(text));

        // データ取得完了後に現在のルートを再描画
        handleRoute();
        
    } catch (error) {
        console.error('Fetch error:', error);
        mainContent.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center text-red-700 m-4">
                <h3 class="font-bold flex justify-center gap-2 items-center">
                    <i data-lucide="alert-circle"></i>データの取得に失敗しました
                </h3>
                <p class="text-sm mt-2">しばらく経ってから再読み込みしてください。</p>
            </div>
        `;
        lucide.createIcons();
    }
}

// --- CSVパーサー ---
function parseCSV(text) {
    const rows = [];
    let currentRow = [], currentVal = '', insideQuote = false;
    for (let i=0; i<text.length; i++) {
        const char = text[i], nextChar = text[i+1];
        if (char === '"') {
            if (insideQuote && nextChar === '"') { currentVal+='"'; i++; } 
            else { insideQuote=!insideQuote; }
        } else if (char === ',' && !insideQuote) { currentRow.push(currentVal); currentVal=''; }
        else if ((char === '\n'||char === '\r') && !insideQuote) {
            if (char==='\r' && nextChar==='\n') i++;
            if (currentRow.length>0 || currentVal) { currentRow.push(currentVal); rows.push(currentRow); }
            currentRow=[]; currentVal='';
        } else { currentVal+=char; }
    }
    if (currentRow.length>0 || currentVal) { currentRow.push(currentVal); rows.push(currentRow); }
    return rows;
}

function transformPosts(rawRows) {
    const posts = [];
    // ヘッダー行(0)をスキップしてデータ行(1)から開始
    for (let i=1; i<rawRows.length; i++) {
        const cols = rawRows[i];
        if (cols.length < 3) continue;
        posts.push({ 
            id: i, 
            timestamp: cols[0].trim(), 
            title: cols[1].trim(), 
            details: cols[2].trim() 
        });
    }
    return posts;
}

// --- ページレンダリング関数 ---

function renderHome() {
    if (allPosts.length === 0) {
        return `<div class="text-center py-16 text-gray-500">読み込み中、または募集がありません。</div>`;
    }

    const sortedPosts = [...allPosts].sort((a,b) => 
        sortOrder === 'newest' ? b.id - a.id : a.id - b.id
    );

    const postListHtml = sortedPosts.map(post => {
        // 表示上の番号（新しい順なら総数から引く、古い順ならIDそのまま）
        const displayIndex = sortOrder === 'newest' 
            ? sortedPosts.length - sortedPosts.indexOf(post) 
            : post.id;
        return createPostCard(post, displayIndex);
    }).join('');

    return `
    <div class="space-y-6 animate-fade-in">
        <section class="bg-gradient-to-r from-blue-50 to-white p-6 rounded-2xl border border-blue-100 shadow-sm">
            <h2 class="text-xl font-bold text-gray-800 mb-2 flex items-center gap-2">
                <i data-lucide="info" class="text-blue-500"></i>このサイトについて
            </h2>
            <p class="text-sm text-gray-600 leading-relaxed">
                大学の研究や心理学実験への協力者を募集しています。<br>
                参加の際は必ず<a href="#policy" class="text-blue-600 hover:underline">ポリシー</a>をご確認ください。
            </p>
        </section>

        <div class="flex justify-between items-center bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
            <p class="text-sm font-bold text-gray-500">${sortedPosts.length}件の募集</p>
            <select id="sort-select" class="text-sm border-gray-200 rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2 bg-gray-50 cursor-pointer">
                <option value="newest" ${sortOrder==='newest'?'selected':''}>新着順</option>
                <option value="oldest" ${sortOrder==='oldest'?'selected':''}>投稿順</option>
            </select>
        </div>

        <div class="space-y-4">
            ${postListHtml}
        </div>
    </div>`;
}

function createPostCard(post, displayIndex) {
    // 改行コードを<br>に変換せず、CSSのwhite-space: pre-wrapで対応
    // XSS対策のためHTMLエスケープが必要ならここで実施（今回は簡易版）
    
    return `
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden group hover:shadow-md transition-shadow duration-300">
        <div class="post-card-trigger p-5 cursor-pointer select-none relative bg-white z-10">
            <div class="flex justify-between items-start mb-2">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    #${displayIndex}
                </span>
                <span class="text-xs text-gray-400 flex items-center gap-1">
                    <i data-lucide="clock" class="w-3 h-3"></i>${post.timestamp}
                </span>
            </div>
            
            <h3 class="text-lg font-bold text-gray-800 mb-2 pr-8 leading-snug group-hover:text-blue-600 transition-colors">
                ${post.title}
            </h3>
            
            <div class="flex items-center justify-between mt-4">
                <span class="text-sm text-blue-500 font-bold flex items-center gap-1 toggle-text">
                    詳細を見る
                </span>
                <i data-lucide="chevron-down" class="chevron-icon w-5 h-5 text-gray-300 group-hover:text-blue-500"></i>
            </div>
        </div>
        
        <div class="post-detail bg-gray-50 border-t border-gray-100">
            <div class="p-6 text-sm text-gray-700 leading-relaxed whitespace-pre-wrap">${post.details}</div>
        </div>
    </div>`;
}

// --- ホーム画面のイベント設定 ---
function attachHomeEvents() {
    // 並び替え
    const sortSelect = document.getElementById('sort-select');
    if(sortSelect) {
        sortSelect.addEventListener('change', (e) => {
            sortOrder = e.target.value;
            handleRoute(); // 再描画
        });
    }

    // アコーディオン開閉
    document.querySelectorAll('.post-card-trigger').forEach(trigger => {
        trigger.addEventListener('click', () => {
            const detail = trigger.nextElementSibling; // .post-detail
            const icon = trigger.querySelector('.chevron-icon');
            const text = trigger.querySelector('.toggle-text');
            
            // max-heightを使って開閉アニメーション
            if (detail.style.maxHeight) {
                // 閉じる
                detail.style.maxHeight = null;
                icon.classList.remove('rotate-180');
                text.textContent = "詳細を見る";
            } else {
                // 開く
                detail.style.maxHeight = detail.scrollHeight + "px";
                icon.classList.add('rotate-180');
                text.textContent = "閉じる";
            }
        });
    });
}

// --- その他ページのレンダリング ---
function renderPolicy() {
    return `
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 animate-fade-in">
        <h2 class="text-2xl font-bold mb-4">利用ポリシー</h2>
        <p class="text-gray-600">ここにポリシーの内容を記載します。</p>
    </div>`;
}

function renderRecruit() {
    return `
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 animate-fade-in">
        <h2 class="text-2xl font-bold mb-4">掲載依頼について</h2>
        <p class="text-gray-600">研究の掲載を希望される方は...</p>
    </div>`;
}

function renderContact() {
    return `
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-8 animate-fade-in">
        <h2 class="text-2xl font-bold mb-4">お問い合わせ</h2>
        <p class="text-gray-600">管理人への連絡はこちら...</p>
    </div>`;
}

// DOM読み込み完了時に実行
document.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
