<script>
  // GoogleスプレッドシートのCSV公開URL
  const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRwty1oe-6s7l6GPnMyo-nhQk2vDfnWKsdlzmgdGo1ey7g1QNLusXc_iIbAJYdE8RhLwRnLobvrBvDV/pub?output=csv';

  const postsContainer = document.getElementById('posts');
  const loading = document.getElementById('loading');
  const error = document.getElementById('error');

  fetch(sheetUrl)
    .then(res => {
      if (!res.ok) throw new Error('ネットワークエラー');
      return res.text();
    })
    .then(csvText => {
      loading.style.display = 'none';
      const rows = parseCSV(csvText).slice(1); // ヘッダーを除く

      if (rows.length === 0) {
        postsContainer.innerHTML = '<p>現在、募集中の実験はありません。</p>';
        return;
      }

      rows.forEach(cols => {
        if (cols.length < 3) return;
        const title = cols[0].trim();
        const body = cols[1].trim();
        const formUrl = cols[2].trim();

        const postDiv = document.createElement('div');
        postDiv.className = 'post card';
        postDiv.innerHTML = `
          <h2>${title}</h2>
          <p>${body}</p>
          <a class="button" href="${formUrl}" target="_blank">応募する</a>
        `;
        postsContainer.appendChild(postDiv);
      });
    })
    .catch(err => {
      console.error('CSV読み込みエラー:', err);
      loading.style.display = 'none';
      error.style.display = 'block';
    });

  // ✅ カンマや改行を含むCSVにも対応した関数
  function parseCSV(str) {
    const rows = [];
    let current = '';
    let inQuotes = false;
    const lines = str.split('\n');
    for (let line of lines) {
      const cols = [];
      let col = '';
      inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const c = line[i];
        if (c === '"') {
          if (inQuotes && line[i + 1] === '"') {
            col += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (c === ',' && !inQuotes) {
          cols.push(col);
          col = '';
        } else {
          col += c;
        }
      }
      cols.push(col);
      rows.push(cols);
    }
    return rows;
  }
</script>
