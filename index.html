<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>被験者募集掲示板</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <!-- ✅ ヘッダー -->
  <header class="site-header">
    <nav class="navbar">
      <h1 class="logo"><a href="index.html">被験者募集掲示板</a></h1>
      <ul class="nav-links">
        <li><a href="index.html">ホーム</a></li>
        <li><a href="policy.html">ポリシー</a></li>
        <li><a href="recruit.html">掲載</a></li>
        <li><a href="contact.html">お問い合わせ</a></li>
      </ul>
    </nav>
  </header>

  <!-- ✅ メインコンテンツ -->
  <main class="container">
    <section class="intro-section">
      <h2>このサイトについて</h2>
      <p>このサイト「被験者募集掲示板」は、研究や実験などへの参加希望者を募集する目的で運営されています。</p>
      <p>研究参加の際はポリシーをご確認ください。</p>
    </section>

    <section id="posts" class="post-list">
      <div id="loading" class="loading">投稿を読み込んでいます...</div>
      <div id="error" class="error" style="display:none;">投稿データを読み込めませんでした。</div>
    </section>
  </main>

  <footer class="footer">
    © 被験者募集掲示板
  </footer>

  <!-- ✅ JavaScript -->
  <script>
    const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRwty1oe-6s7l6GPnMyo-nhQk2vDfnWKsdlzmgdGo1ey7g1QNLusXc_iIbAJYdE8RhLwRnLobvrBvDV/pub?gid=821609257&single=true&output=csv";
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwaMGt-e6TBlvvYMY9YWvFT7_aDs-sQ8E4Zy55wxsd87lpNEPRWKaPzaWHgsJkyp6hHUA/exec";

    const postsContainer = document.getElementById("posts");
    const loading = document.getElementById("loading");
    const error = document.getElementById("error");

    function parseCSV(text) {
      const lines = text.trim().split("\n").map(l => l.split(","));
      return lines.slice(1);
    }

    // 投稿を読み込み
    fetch(SHEET_CSV_URL)
      .then(res => res.text())
      .then(csvText => {
        const rows = parseCSV(csvText);
        postsContainer.innerHTML = "";

        if (rows.length === 0) {
          postsContainer.innerHTML = "<p>現在、募集中の実験はありません。</p>";
          return;
        }

        rows.reverse().forEach((cols, i) => {
          const postId = rows.length - i;
          const timestamp = cols[0];
          const title = cols[1];
          const detail = cols[2]?.replace(/\r?\n/g, "<br>") || "";

          const post = document.createElement("div");
          post.className = "post card";
          post.innerHTML = `
            <div class="post-header">
              <span class="post-number">#${postId}</span>
              <span class="post-timestamp">${timestamp}</span>
              <h2>${title}</h2>
            </div>
            <div class="post-detail" style="display:none;">
              <p>${detail}</p>
            </div>
            <div class="btn-area">
              <button class="heart-btn" title="いいね" data-id="${postId}">❤️ <span class="heart-count">0</span></button>
              <button class="report-btn" title="通報" data-id="${postId}">🚨 <span class="report-count">0</span></button>
            </div>
            <button class="toggle-btn">▼ 詳細を表示</button>
          `;
          postsContainer.appendChild(post);

          const toggleBtn = post.querySelector(".toggle-btn");
          const detailEl = post.querySelector(".post-detail");
          toggleBtn.addEventListener("click", () => {
            const isVisible = detailEl.style.display === "block";
            detailEl.style.display = isVisible ? "none" : "block";
            toggleBtn.textContent = isVisible ? "▼ 詳細を表示" : "▲ 閉じる";
          });

          const heartBtn = post.querySelector(".heart-btn");
          const reportBtn = post.querySelector(".report-btn");
          const heartCount = post.querySelector(".heart-count");
          const reportCount = post.querySelector(".report-count");

          // ✅ Google Apps Scriptから合計取得
          fetch(`${GAS_URL}?action=get&id=${postId}`)
            .then(res => res.json())
            .then(data => {
              heartCount.textContent = data.heart || 0;
              reportCount.textContent = data.report || 0;
            });

          // ✅ 1人1回制限
          if (localStorage.getItem(`heart_${postId}`)) heartBtn.disabled = true;
          if (localStorage.getItem(`report_${postId}`)) reportBtn.disabled = true;

          // ✅ クリック時
          heartBtn.addEventListener("click", () => handleClick(postId, "heart", heartBtn, heartCount));
          reportBtn.addEventListener("click", () => handleClick(postId, "report", reportBtn, reportCount));
        });
      })
      .catch(err => {
        console.error("CSV読み込みエラー:", err);
        loading.style.display = "none";
        error.style.display = "block";
      });

    // ✅ ボタンクリック処理
    function handleClick(id, type, button, countSpan) {
      if (localStorage.getItem(`${type}_${id}`)) return;
      button.disabled = true;
      localStorage.setItem(`${type}_${id}`, "true");

      let current = parseInt(countSpan.textContent) || 0;
      countSpan.textContent = current + 1;

      fetch(`${GAS_URL}?action=update&id=${id}&type=${type}`, { method: "POST" })
        .catch(err => console.error("送信エラー:", err));
    }
  </script>
</body>
</html>
